---
title: "Figures"
author: "Maddy Kline"
date: "2023-06-06"
output:
  pdf_document: default
  html_document: default
---

```{r global options, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(stringr)
library(ggplot2)
library(usmap)
library(gridExtra)
library(maps)
library(mapdata)
library(ggmap)
library(lmtest)
library(tidycensus)
library(data.table)
library(RColorBrewer)
library(rgdal)
library(broom)
library(ggpattern)
library(ggrepel)
library(USpopcenters)
library(gifski)
library(animation)

set.seed(2023)
```


# Read in data
```{r read_data}
dat <- read_csv("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/Strep_project/private_data/old/fulldat.csv") #change this path to be accurate
coh <- read_csv("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/Strep_project/private_data/old/GeoCohort.csv") #change path to be accurate

#school start data
ss_dat_trim <- read_csv("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/Strep_project/private_data/ss_dat_trim.csv")
#set color palette for regions
colors_df <- data.frame(Region = c("South", "Midwest", "Northeast", "West"),
                        region_color = c("#DE6C83", "#43AA8B", "#2274A5", "#EDDEA4"))

#set color palette for subregions (subdivisions of regions)
pal <- brewer.pal(n= 9, name = "Paired")
subcolors_df <- data.frame(Region = c("East South Central", "West South Central",
                                      "West North Central", "South Atlantic", "Middle Atlantic",
                                      "Mountain West", "East North Central", "New England", "Pacific West"),
                           region_color = c(pal[6], pal[5], pal[4], pal[9], pal[2], pal[8], pal[3], pal[1], pal[7]))


```
# Read in helper files
```{r}
source("get_popsizes.R")
source("get_regions.R")
source("get_subregions.R")
source("yearly_average_functions.R")
source("monthly_average_functions.R")
source("get_state_sinusoids.R")
source("region_subregion_sinusoid_functions.R")
source("age_analyses.R")
```




Calculate the proportion of the population represented in the dataset for calculation in line 110
```{r pop proportion}
total_us_pop_years_df <- data.frame(YEAR = c(2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018), 
                                    pop = c(309414110, 311580009, 313874218, 316057727, 318386421,
                                            320742673, 323071342, 325147121, 327167434))
yearly_memb <- coh |> group_by(YEAR) |>
  summarize(yearly_memb = sum(NMEMB))
#percentage of population represented by the database
rep <- left_join(yearly_memb, total_us_pop_years_df) |> mutate(perc = yearly_memb / pop)
rep |> arrange(yearly_memb)
```



# Summarize characteristics of the cohort
Average membership by sex, age group, region, and subregion. Becomes Table 1.
```{r table1}
#total
total_range <- coh |> group_by(YEAR) |>
  summarize(membership = sum(NMEMB)) |>
  summarize(avg_membership = mean(membership), min = min(membership), max = max(membership))

total_df <- data.frame(Category = "Total", avg_membership = total_range$avg_membership, 
                       perc = 1, min = total_range$min, max = total_range$max)

total_avg_memb <- total_df$avg_membership

#sex membership
sex_membership <- coh |> group_by(SEX, YEAR) |>
  summarize(membership = sum(NMEMB)) |>
  group_by(SEX) |>
  summarize(avg_membership = mean(membership), min = min(membership), max = max(membership)) |>
  mutate(perc = avg_membership / total_avg_memb) |>
  mutate(Category = SEX) |>
  mutate(Category = c("Male", "Female")) |>
  select(Category, avg_membership, perc, min,max) 

#age membership
age_membership <- coh |> group_by(AGEGRP, YEAR) |>
  summarize(membership = sum(NMEMB)) |>
  group_by(AGEGRP) |>
  summarize(avg_membership = mean(membership), min = min(membership), max = max(membership)) |>
  mutate(perc = avg_membership / total_avg_memb) |>
  mutate(Category = AGEGRP) |>
  select(Category, avg_membership, perc, min, max) 


#region membership
regions_membership <- coh |> 
  left_join(regions) |> group_by(part, YEAR) |>
  summarize(membership = sum(NMEMB)) |>
  group_by(part) |>
  summarize(avg_membership = mean(membership), min = min(membership), max = max(membership)) |> mutate(Category = str_to_title(part)) |>
  select(Category, avg_membership, min, max) |> 
  mutate(perc = avg_membership / total_avg_memb) |>
  select(Category, avg_membership, perc, min, max)

#subregion membership
subregions_membership <- coh |> left_join(subregions) |> group_by(part, YEAR) |>
  summarize(membership = sum(NMEMB)) |>
  group_by(part) |>
  summarize(avg_membership = mean(membership), min = min(membership), max = max(membership))

subregions_membership <- subregions_membership |> mutate(Category = gsub("_", " ", subregions_membership$part, fixed=TRUE)) |>
  select(Category, avg_membership, min, max) |> 
  mutate(perc = avg_membership / total_avg_memb) |>
  select(Category, avg_membership, perc, min, max)

sex_df <- data.frame(Category = "Sex", avg_membership = NA, 
                     perc = NA, min = NA, max = NA)

age_df <- data.frame(Category = "Age Group", avg_membership = NA, 
                     perc = NA, min = NA, max = NA)
subregion_df <- data.frame(Category = "Subregion", avg_membership = NA, 
                        perc = NA, min = NA, max = NA)
region_df <- data.frame(Category = "Region", avg_membership = NA, 
                        perc = NA, min = NA, max = NA)

table1 <- rbind(total_df, sex_df, sex_membership, age_df, age_membership, region_df, regions_membership, subregion_df, subregions_membership) |> mutate(avg_membership = avg_membership / 10^6, min = round(min / 10^6, 2), max = round(max / 10^6, 2)) |>
  mutate(Average_Membership = round(avg_membership, digits = 2)) |>
  mutate("%" = round(perc*100, 2),
        Average_Membership = paste0(Average_Membership," ","(", min, "-", max, ")")) |>
  select(Category, Average_Membership, `%`)
```

# Calculate average membership by state
For quality control, threshold was set at an average of >5,000 members per year. Becomes Supplementary Figure 1.
```{r figS1}
continental_state_membership_noSC <- coh |> 
  filter(!STATE %in% c('Hawaii', 'Alaska', 'South Carolina')) |> 
  group_by(STATE, YEAR) |> 
  summarize(total_memb = sum(NMEMB)) |>
  group_by(STATE) |>
  summarize(NMEMB = mean(total_memb)) |>
  ggplot(aes(x = reorder(STATE, -NMEMB), y = log(NMEMB))) + 
  geom_bar(stat = "identity") +
  geom_hline(yintercept = log(5000), linetype = 2, color = "red") +
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
  # ggtitle("Average Yearly Membership by State, 2010-2018") +
  ylab("Log Average Yearly Membership") +
  xlab("State")
```


# Yearly regional and subregional differences in disease burden
Calculate the total visits per 1000 members across all years by region. Becomes figure S2a.
```{r Figure S2a}
vis_year <- dat |> group_by(STATE, SEX, AGEGRP, YEAR) |> summarize(yearly_visits = sum(NVISITS))
regions_weighted_allyears <- get_yearly_differences(regions) |> mutate(Region = str_to_title(part)) |> 
  left_join(colors_df) |> mutate(Region = factor(Region, levels = c("South", "Midwest", "Northeast", "West")))
#plot 
region_differences_byyear <- regions_weighted_allyears |> ggplot(aes(YEAR, sum_region_cases_per_thousand, group = Region, color=Region)) +
  geom_line() + scale_color_manual(values= colors_df$region_color) + theme_minimal() +
  ylab("Visits per 1000") + xlab("Year") + labs(color = "Region") + 
  # ggtitle("Streptococcal Pharyngitis Visits by Region over Time") +
  theme(plot.title = element_text(hjust = 0.5, size = 20))

region_differences_byyear_forfig <- regions_weighted_allyears |> ggplot(aes(YEAR, sum_region_cases_per_thousand, group = Region, color=Region)) +
  geom_line() + scale_color_manual(values= colors_df$region_color) + theme_minimal() +
  ylab("Visits per 1000") + xlab("Year") + labs(color = "Region") + 
  # ggtitle("Streptococcal Pharyngitis Visits by Region over Time") +
  theme(plot.title = element_text(hjust = 0.5, size = 20), legend.position = "none")
```

Calculate average visits per year in each region and statistically compare
```{r supplementary Figure 2}
avg_yearly_regions <- regions_weighted_allyears |>
  group_by(Region) |>
  summarize(avg_vis_thous = mean(sum_region_cases_per_thousand), sd = sd(sum_region_cases_per_thousand)) |>
  mutate(lower = avg_vis_thous - 1.96*sd/sqrt(9), upper = avg_vis_thous + 1.96*sd/sqrt(9)) |>
  mutate(Region = factor(Region, levels = c("South", "Midwest", "Northeast", "West"))) |>
  arrange(Region)

region_table <- avg_yearly_regions |>
  mutate("95%CI" = paste0("(", round(lower,2), "-", round(upper,2), ")")) |>
  select(Region, avg_vis_thous, `95%CI`)

year_averages_plot <- avg_yearly_regions |> 
  ggplot(aes(Region, avg_vis_thous, color = Region)) + 
  geom_point() +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
  scale_color_manual(values= colors_df$region_color, labels = colors_df$Region) +
  ylab("Visits per 1000") +
  # ggtitle("Streptococcal Pharyngitis Average Visits by Region") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 60, vjust = 0.5, hjust=0.5))


#make dataframe and perform each t-test
ttest_table_reg <- expand_grid(region1 = c("South", "Midwest", "Northeast", "West"), 
            region2 = c("South", "Midwest", "Northeast", "West")) |>
  filter(region1 != region2) |>
  mutate(Comparison = paste0(region1, "-", region2)) |>
  filter(!Comparison %in% c("Midwest-South", "Northeast-South", "Northeast-Midwest",
                            "West-South", "West-Midwest", "West-Northeast"))

ttest_table_reg <- fill_table(ttest_table_reg, regions_weighted_allyears, avg_yearly_regions)

region_comparisons <- ttest_table_reg |> 
  ggplot(aes(x = -log(pvals), y = diff, shape = Comparison)) +
  geom_point() +
  geom_vline(xintercept = -log(0.05/6), linetype = 2, color = "red") +
  xlab("Negative Log P-value") +
  ylab("Difference in Visits per 1000") + 
  # ggtitle("Streptococcal Pharyngitis Average Yearly Region Comparisons") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, size = 18))
```

Total visits per 1000 members across all years by subregion as well as calculation of average visits per year in each region and statistical comparison. Becomes Supplementary Figure 3.
```{r Supplementary Figure 3}
subregions_weighted_allyears <- get_yearly_differences(subregions) |> mutate(Region = str_to_title(part)) |> 
  left_join(subcolors_df) |> mutate(Region = factor(Region, levels = subcolors_df$Region))

subregion_differences_byyear <- subregions_weighted_allyears |> ggplot(aes(YEAR, sum_region_cases_per_thousand, group = Region, color=Region)) +
  geom_line() + scale_color_manual(values= subcolors_df$region_color) + theme_minimal() +
  ylab("Visits per 1000") + xlab("Year") + labs(color = "Subegion") + 
  # ggtitle("Streptococcal Pharyngitis Visits by Subregion over Time") +
  theme(plot.title = element_text(hjust = 0.5, size = 20))

subregion_differences_byyear_forfig <- subregions_weighted_allyears |> ggplot(aes(YEAR, sum_region_cases_per_thousand, group = Region, color=Region)) +
  geom_line() + scale_color_manual(values= subcolors_df$region_color) + theme_minimal() +
  ylab("Visits per 1000") + xlab("Year") + labs(color = "Subegion") + 
  # ggtitle("Streptococcal Pharyngitis Visits by Subregion over Time") +
  theme(plot.title = element_text(hjust = 0.5, size = 20), legend.position = "none")

avg_yearly_subregions <- subregions_weighted_allyears |>
  group_by(Region) |>
  summarize(avg_vis_thous = mean(sum_region_cases_per_thousand), sd = sd(sum_region_cases_per_thousand)) |>
  mutate(lower = avg_vis_thous - 1.96*sd/3, upper = avg_vis_thous + 1.96*sd/3) |>
  arrange(-avg_vis_thous) |> 
  left_join(subcolors_df)
order <- avg_yearly_subregions |> pull(Region)  
avg_yearly_subregions <- avg_yearly_subregions |>
  mutate(Region = factor(Region, levels = order))

#write_csv(avg_yearly_subregions, "year_subregions_sd.csv")

subregion_table <- avg_yearly_subregions |>
  mutate("95%CI" = paste0("(", round(lower,2), "-", round(upper,2), ")")) |>
  select(Region, avg_vis_thous, `95%CI`)

year_averages_plot_subregions <- avg_yearly_subregions |> 
  ggplot(aes(reorder(Region, -avg_vis_thous), avg_vis_thous, color = Region)) + 
  geom_point() +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
  scale_color_manual(name = "Subregion", values= avg_yearly_subregions$region_color, labels = avg_yearly_subregions$Region) +
  ylab("Visits per 1000") + 
  # ggtitle("Streptococcal Pharyngitis Average Visits by Region") +
  theme_minimal() +
  xlab("Subregion") + 
  theme(axis.text.x = element_blank()) 

ttest_table_sub <- expand_grid(region1 = subregion_table$Region, 
                           region2 = subregion_table$Region) |>
  filter(region1 != region2) |>
  mutate(Comparison = paste0(region1, "-", region2)) |>
  filter(!Comparison %in% c("West South Central-East South Central",
                            "West North Central-East South Central",
                            "West North Central-West South Central",
                            "South Atlantic-East South Central",
                            "South Atlantic-West South Central",
                            "South Atlantic-West North Central",
                            "Middle Atlantic-East South Central",
                            "Middle Atlantic-West South Central",
                            "Middle Atlantic-West North Central",
                            "Middle Atlantic-South Atlantic",
                            "Mountain West-East South Central",
                            "Mountain West-West South Central",
                            "Mountain West-West North Central",
                            "Mountain West-South Atlantic",
                            "Mountain West-Middle Atlantic",
                            "East North Central-East South Central",
                            "East North Central-West South Central",
                            "East North Central-West North Central",
                            "East North Central-South Atlantic",
                            "East North Central-Middle Atlantic",
                            "East North Central-Mountain West",
                            "New England-East South Central",
                            "New England-West South Central",
                            "New England-West North Central",
                            "New England-South Atlantic",
                            "New England-Middle Atlantic",
                            "New England-Mountain West",
                            "New England-East North Central",
                            "Pacific West-East South Central",
                            "Pacific West-West South Central",
                            "Pacific West-West North Central",
                            "Pacific West-South Atlantic",
                            "Pacific West-Middle Atlantic",
                            "Pacific West-Mountain West",
                            "Pacific West-East North Central",
                            "Pacific West-New England"
                            
                            ))

ttest_table_sub <- fill_table(ttest_table_sub, subregions_weighted_allyears,avg_yearly_subregions)
ttest_table_sub <- ttest_table_sub |> mutate(diff = round(diff, 2), pvals = signif(pvals,digits=3)) |>
  select(Comparison, pvals, diff) |> arrange(desc(pvals))
```

# Average monthly regional and subregional differences 
Calculate average monthly visits by region, becomes Figure 1.
```{r Figure 1}
regions_weighted_allyears <- calculate_averages(c("Hawaii", "Alaska"), regions)[[2]] |> 
  mutate(Region = str_to_title(part)) |> 
  left_join(colors_df) |> mutate(Region = factor(Region, levels = c("South", "Midwest", "Northeast", "West")))

regions_weighted <- calculate_averages(c("Hawaii", "Alaska"), regions)[[3]] |>
  mutate(Region = str_to_title(part)) |> 
  left_join(colors_df) |> mutate(Region = factor(Region, levels = c("South", "Midwest", "Northeast", "West")))
  

points_region_plot <- plot_averages_CIs_points(regions_weighted, 
                         regions_weighted_allyears,
                         colors_df) + labs(title = NULL) + xlab("Month")

#corresponding table of values
region_table_month <- calculate_averages(c("Hawaii", "Alaska"), regions)[[3]] |> 
  mutate(CI = paste0("(", round(yearly_average_sum_region_cases_per_thousand - 1.96*sd/3, 2), "-", 
                     round(yearly_average_sum_region_cases_per_thousand + 1.96*sd/3, 2), ")")) |>
  mutate(Region = str_to_title(part), 
         Month = MONTH,
         Visits_per_1000 = yearly_average_sum_region_cases_per_thousand) |>
  mutate('Visits(CI)' = paste(round(Visits_per_1000,2), CI)) |>
  select(Region, Month, `Visits(CI)`) 
  
region_table_month <- region_table_month[,2:4] |> pivot_wider(names_from = Region, values_from = `Visits(CI)`)

```

Average subregional differences over the course of the year. Becomes Supplementary Figure 4.
```{r supplementary figure 4}
subregions_weighted_allyears <- calculate_averages(c("Hawaii", "Alaska"), subregions)[[2]] |> 
  mutate(Region = factor(str_to_title(part), levels = c("East South Central", "West South Central",
                                      "West North Central", "South Atlantic", "Middle Atlantic",
                                      "Mountain West", "East North Central", "New England", "Pacific West"))) 

subregions_weighted <- calculate_averages(c("Hawaii", "Alaska"), subregions)[[3]] |>
  mutate(Region = factor(str_to_title(part), levels = c("East South Central", "West South Central",
                                      "West North Central", "South Atlantic", "Middle Atlantic",
                                      "Mountain West", "East North Central", "New England", "Pacific West")))
  

points_subregion_plot <- plot_averages_CIs_points(subregions_weighted, 
                         subregions_weighted_allyears,
                         subcolors_df) + labs(title = NULL) + xlab("Month")

#tables with corresponding values
subregion_table_month <- calculate_averages(c("Hawaii", "Alaska"), subregions)[[3]] |> 
  mutate(CI = paste0("(", round(yearly_average_sum_region_cases_per_thousand - 1.96*sd/3, 2), "-", 
                     round(yearly_average_sum_region_cases_per_thousand + 1.96*sd/3, 2), ")")) |>
  mutate(Region = str_to_title(part), 
         Month = MONTH,
         Visits_per_1000 = yearly_average_sum_region_cases_per_thousand) |>
  mutate('Visits(CI)' = paste(round(Visits_per_1000,2), CI)) |>
  select(Region, Month, `Visits(CI)`) 

subregion_table_month <- subregion_table_month[,2:4] |> 
  mutate(Region = gsub("_", " ",subregion_table_month$Region , fixed=TRUE)) |>
  mutate(Region = str_to_title(Region)) |>
  pivot_wider(names_from = Region, values_from = `Visits(CI)`)
```


# Average quarterly visits between regions and subregions
Calculate average quarterly visits over 3 month chunks, becomes Figure S5a
```{r supplementary figure 5a}
quarter_df <- data.frame(MONTH = c(1:12), quarter = c(1,1,1,2,2,2,3,3,3, 4,4,4))
quarters <- left_join(regions_weighted_allyears, quarter_df) |> group_by(part, YEAR, quarter) |> summarize(quarter_vis = sum(sum_region_cases_per_thousand)) |>
  mutate(part = factor(part, levels = c("South", "Midwest", "Northeast", "West")))


region_quarters_plot <- quarters |> group_by(part, quarter) |> summarize(avg_quart_vis = mean(quarter_vis), sd= sd(quarter_vis)) |>
  mutate(lower = avg_quart_vis - 1.96*sd/3, upper = avg_quart_vis + 1.96*sd/3) |>
  ggplot(aes(quarter, avg_quart_vis, fill = part)) + geom_bar(position = 'dodge', stat = 'identity') +
  geom_errorbar(aes(x =quarter, ymin = lower, ymax = upper), position = 'dodge',  alpha = 0.2)+ scale_fill_manual(values = colors_df$region_color, labels = colors_df$Region) + theme_minimal() + labs(fill = "Region") + ylab("Visits per 1000 People") + xlab("Quarter")

#save table of average quarterly values
region_quarters_table <- quarters |> group_by(part, quarter) |> summarize(avg_quart_vis = mean(quarter_vis), sd= sd(quarter_vis)) |>
  mutate(lower = avg_quart_vis - 1.96*sd/3, upper = avg_quart_vis + 1.96*sd/3) |>
  mutate("Average_Visits(95%CI)" = paste0(round(avg_quart_vis, 2), " ", "(", round(lower,2), "-", round(upper, 2), ")")) |>
  select(part, quarter, `Average_Visits(95%CI)`)

```

Calculate average subregional visits over 3 month chunks, becomes Figure S5b
```{r supplementary figure 5b}
sub_quarters <- left_join(subregions_weighted_allyears, quarter_df) |> group_by(part, YEAR, quarter) |> summarize(quarter_vis = sum(sum_region_cases_per_thousand)) |> mutate(part = factor(part, levels = c("East South Central", "West South Central",
                                      "West North Central", "South Atlantic", "Middle Atlantic",
                                      "Mountain West", "East North Central", "New England", "Pacific West")))

subregion_quarters_plot <- sub_quarters |> group_by(part, quarter) |> summarize(avg_quart_vis = mean(quarter_vis), sd= sd(quarter_vis)) |>
  mutate(lower = avg_quart_vis - 1.96*sd/3, upper = avg_quart_vis + 1.96*sd/3) |>
  ggplot(aes(quarter, avg_quart_vis, fill = part)) + geom_bar(position = 'dodge', stat = 'identity') +
  geom_errorbar(aes(x =quarter, ymin = lower, ymax = upper), position = 'dodge',  alpha = 0.2)+ scale_fill_manual(values = subcolors_df$region_color, labels = subcolors_df$Region) + theme_minimal() + labs(fill = "Subregion") + ylab("Visits per 1000 People") + xlab("Quarter")

subregion_quarters_table <- sub_quarters |> group_by(part, quarter) |> summarize(avg_quart_vis = mean(quarter_vis), sd= sd(quarter_vis)) |>
  mutate(lower = avg_quart_vis - 1.96*sd/3, upper = avg_quart_vis + 1.96*sd/3) |>
  mutate("Average_Visits(95%CI)" = paste0(round(avg_quart_vis, 2), " ", "(", round(lower,2), "-", round(upper, 2), ")")) |>
  select(part, quarter, `Average_Visits(95%CI)`)

```

Calculate average differences between regions, becomes Supplementary Table 4 
```{r table S4}
#initialize df
quarter_diff_allyears <- expand_grid(Comparison = c("West-South", "West-Northeast", "West-Midwest", "South-Northeast", "South-Midwest", "Northeast-Midwest"), Year = c(2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018), Quarter = c(1,2,3,4)) |> mutate(Diff = NA)

#loop through rows in df and fill 
for(i in 1:nrow(quarter_diff_allyears)){
  R1 = quarters |> filter(part == strsplit(quarter_diff_allyears$Comparison[i], "-")[[1]][1], 
                          YEAR == quarter_diff_allyears$Year[i],
                          quarter == quarter_diff_allyears$Quarter[i]) |>
    pull(quarter_vis)
  R2 = quarters |> filter(part == strsplit(quarter_diff_allyears$Comparison[i], "-")[[1]][2], 
                          YEAR == quarter_diff_allyears$Year[i],
                          quarter == quarter_diff_allyears$Quarter[i]) |>
    pull(quarter_vis)
  quarter_diff_allyears$Diff[i] <- R1-R2
}

quarter_diffs_table <- quarter_diff_allyears |> group_by(Comparison, Quarter) |> summarize(avg_diff = mean(as.numeric(Diff)), sd = sd(as.numeric(Diff))) |> 
  mutate(abs_avg_diff = abs(avg_diff), 
         lower = abs_avg_diff - 1.96*sd/3,
         upper = abs_avg_diff + 1.96*sd/3) |>
  mutate('Abs_Avg_diff(CI)' = paste0(round(abs_avg_diff, 2), " ", "(", round(lower, 2), "-", round(upper, 2), ")")) |>
  select(Comparison, Quarter, `Abs_Avg_diff(CI)`)
```

# Statistically compare each month and region or subregion
T-tests comparing each region-month, becomes Supplementary Figure 6a 
```{r supplementary figure 6a}
#create table of regional differences and p-values from T-test
#using helper function "get_diff_df" from "monthly_average_functions.R"
wide_table_regions <- get_diff_df(c("Hawaii", "Alaska"), regions) |>
  filter(region1 != region2) |> 
  mutate("Diff(pval)" = paste0(round(diff,3), "(",round(pval,8), ')')) |>
  select(-region1, -region2, -diff, -pval) |>
  pivot_wider(names_from = Comparison, values_from = `Diff(pval)`)

#build heat map
#calculate regional differences
region_US_cont <- get_diff_df(c("Hawaii", "Alaska"), regions) 

#calculate bonferroni-corrected p-value threshold
val <- 0.05 / nrow(region_US_cont)

#remove self and redundant comparisons
region_heatmap_significance_noredund <- region_US_cont |> mutate(sig = ifelse(pval < val, 0,1)) |> 
  filter(region1 != region2) |> 
  filter(!Comparison %in% c("South-West", "Northeast-West", 
                            "Northeast-South", "Midwest-West", 
                            "Midwest-Northeast", "Midwest-South")) |>
  ggplot(aes(x = MONTH, y = Comparison, fill = factor(sig))) + geom_tile() + 
  xlab("Month") +
  scale_fill_manual(values = c('#0096FF','grey'),  labels = c("Yes", "No")) + theme_minimal() + 
  labs(fill = "Significant") +
  scale_x_discrete(limits = c("JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEPT","OCT", "NOV", "DEC")) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size = 20)) 

```

T-tests comparing each subregion-month, becomes Supplementary Figure 6b
```{r supplementary figure 6b}
#create table of subregional differences and p-values from T-test
wide_table_subregions <- get_diff_df(c("Hawaii", "Alaska"), subregions) |> 
  filter(region1 != region2) |> 
  mutate("Diff(pval)" = paste0(round(diff,3), "(",round(pval,8), ')')) |>
  select(-region1, -region2, -diff, -pval) |>
  pivot_wider(names_from = Comparison, values_from = `Diff(pval)`)

#subregion heat map 
subregion_order_heatmap <- data.frame(region2 = c("Pacific West", "Mountain West", "West North Central", "West South Central","East North Central", "East South Central", "Middle Atlantic","South Atlantic", "New England"),order = c(1:9))
subregion_US_cont <- get_diff_df(c("Hawaii", "Alaska"), subregions) 
val2 <- 0.05 / nrow(subregion_US_cont)
subregion_US_cont <- subregion_US_cont |> 
  mutate(sig = ifelse(pval < val2, 0,1)) |> 
  filter(region1 != region2)

#remove redundancies
subregion_US_cont2 <- subregion_US_cont |>
  filter(!Comparison %in% c("Pacific West-Mountain West",
                            "Pacific West-West North Central",
                            "Mountain West-West North Central",
                            "Pacific West-West South Central",
                            "Mountain West-West South Central",
                            "West North Central-West South Central",
                            "Pacific West-East North Central",
                            "Mountain West-East North Central",
                            "West North Central-East North Central",
                            "West South Central-East North Central",
                            "Pacific West-East South Central",
                            "Mountain West-East South Central",
                            "West North Central-East South Central",
                            "West South Central-East South Central",
                            "East North Central-East South Central",
                            "Pacific West-Middle Atlantic",
                            "Mountain West-Middle Atlantic",
                            "West North Central-Middle Atlantic",
                            "West South Central-Middle Atlantic",
                            "East North Central-Middle Atlantic",
                            "East South Central-Middle Atlantic",
                            "Pacific West-South Atlantic",
                            "Mountain West-South Atlantic",
                            "West North Central-South Atlantic",
                            "West South Central-South Atlantic",
                            "East North Central-South Atlantic",
                            "East South Central-South Atlantic",
                            "Middle Atlantic-South Atlantic",
                            "Pacific West-New England",
                            "Mountain West-New England",
                            "West North Central-New England",
                            "West South Central-New England",
                            "East North Central-New England",
                            "East South Central-New England",
                            "Middle Atlantic-New England",
                            "South Atlantic-New England")) |>
  left_join(subregion_order_heatmap) |> 
  group_by(MONTH) |>
  arrange(order) |>
  mutate(Comparison2 = str_to_title(gsub("_", " ", Comparison, fixed=TRUE))) |>
  select(-Comparison) |>
  mutate(Comparison = Comparison2) |>
  select(-Comparison2)

subregion_heatmap_significance_noredund <- subregion_US_cont2 |> 
  ggplot(aes(x = MONTH, y = reorder(Comparison, -order), fill = factor(sig))) + geom_tile() + 
  scale_fill_manual(values = c('#0096FF','grey'),  labels = c("Yes", "No")) + theme_minimal() + 
  ylab("Comparison") + 
  xlab("Month") +
  labs(fill = "Significant") +
  scale_x_discrete(limits = c("JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEPT","OCT", "NOV", "DEC")) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size = 25))
```


# Sinusoidal Fitting
Fitting state visit trends to sinusoids
```{r state phases, supplementary table 5}
#state_sinusoids_parameters and state_sinusoids called from get_state_sinusoids.R helper file
#make a table of all state phases (Supplementary Table 5)
phase_table <- state_sinusoids_parameters |> mutate(Phase_corrected = Phase %% 12) |>
  mutate(Phase_lower = Phase_corrected - 1.96*Phase_SE,
         Phase_upper = Phase_corrected + 1.96*Phase_SE) |>
  mutate(Final_phase = paste0(round(Phase_corrected,2), " ", "(", round(Phase_lower,2), "-", round(Phase_upper,2), ")")) |>
  filter(!State %in% c("South Carolina", "Hawaii", "Alaska")) |>
  select(State, Final_phase) |>
  mutate("Phase(95% CI)" = Final_phase) |>
  select(-Final_phase)
```


Plot state phases on a map of the U.S., becomes Figure 2.
```{r figure 2}
#load US shapefile
my_spdf <- readOGR(dsn = "/Users/madeleinekline/Dropbox (Harvard University)/GradLab/Strep_project/R code/plots/More_final_figures/mapping/cb_2018_us_state_500k",
                   layer = "cb_2018_us_state_500k")
# https://www.census.gov/geographies/mapping-files/time-series/geo/carto-boundary-file.html
spdf_fortified <- tidy(my_spdf)

#remove non-continental US states and territories
non_continental_ids <- which(!(my_spdf$NAME %in% c("American Samoa" , 
                                   "Commonwealth of the Northern Mariana Islands", 
                                   "Guam",
                                   "Hawaii",
                                   "Alaska",
                                   "Puerto Rico",
                                   "United States Virgin Islands")))
continental <- my_spdf[non_continental_ids,]

#fortify shapefile
continental_fortified <- tidy(continental)

#add back in state names which were lost in tidy()
temp_df <- data.frame(my_spdf@data$NAME)
names(temp_df) <- c("NAME")
temp_df$id <-as.character(seq(0, nrow(temp_df)-1))
state_names <- left_join(continental_fortified, temp_df) |> mutate(State = NAME) |> select(-NAME)
continental_fortified_tojoin <- left_join(continental_fortified, state_names) |> select(-id) |> mutate(id = State) |> select(-State)

#correct state phases for map
state_sinusoids_parameters_tojoin <- state_sinusoids_parameters |> mutate(Phase_corrected = Phase %% 12, 
                                                                          id = State) |> select(id, Phase_corrected)
#add phase data to shapefile
continental_phases <- left_join(continental_fortified_tojoin, state_sinusoids_parameters_tojoin) 
#remove South Carolina
continental_phases_noSC <- continental_phases
continental_phases_noSC[which(continental_phases_noSC$id == "South Carolina"),8] = NA
sc <- continental_phases[which(continental_phases$id == "South Carolina"),]
state_phases_map_noSC <- ggplot() + 
  geom_polygon(data = continental_phases_noSC, aes(x = long, y = lat, group = group, fill = Phase_corrected), color="black") +
  geom_polygon_pattern(data = sc, aes(x = long, y = lat, group= group), fill = "gray", pattern = 'stripe', 
                       pattern_spacing = 0.005, pattern_alpha = 0.5) +
  theme_void() + ggtitle("") + scale_fill_gradient(low = "#30239B", high =  "#FFFFFF", breaks = c(0, 1, 2, 3), 
                                                   labels = c("Dec", "Jan", "Feb", "Mar"),
                                                   limits = range(0,3)) + 
  labs(fill = "Peak Month") +
  theme(plot.title = element_text(hjust = 0.5, size = 25),
        plot.subtitle = element_text(hjust = 0.5, size = 23),
        legend.position = 'bottom')
```
Plot state sinusoids with confidence intervals, becomes Supplementary Figure 10
```{r supplementary figure 9}
state_sinusoids_subregions <- ggplot() + 
  geom_point(aes(x = MONTH, y = mean_weighted_cases_per_thousand, color = Region), data = state_sinusoids_withCIs_cont_sub, size = 0.5) + 
  geom_ribbon(aes(x = MONTH, ymin = lower, ymax = upper, fill = Region), data = state_sinusoids_withCIs_cont_sub, alpha = 0.2) +
  geom_line(aes(x = MONTH, y = prediction, color = Region), data = state_sinusoids_withCIs_cont_sub, linetype = 2) +
  scale_color_manual(values= subcolors_df$region_color, labels=gsub("_", " ",subcolors_df$Region , fixed=TRUE)) +
  scale_fill_manual(values = subcolors_df$region_color, labels=gsub("_", " ",subcolors_df$Region , fixed=TRUE)) +
  facet_wrap(~STATE) +
  # ggtitle("Streptococcal Pharyngitis Visits State Sinusoidal Fits") +
  labs(color = "Subregion", fill = "Subregion") + 
  xlab("Month") +
  ylab("Visits per 1,000 People") +
  scale_x_discrete(limits = c("JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEPT","OCT", "NOV", "DEC")) +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size = 20)) 

#only in the <19 population
state_sinusoids_subregions_under19 <- ggplot() + 
  geom_point(aes(x = MONTH, y = mean_weighted_cases_per_thousand, color = Region), data = state_sinusoids_withCIs_cont_sub_under19, size = 0.5) + 
  geom_ribbon(aes(x = MONTH, ymin = lower, ymax = upper, fill = Region), data = state_sinusoids_withCIs_cont_sub_under19, alpha = 0.2) +
  geom_line(aes(x = MONTH, y = prediction, color = Region), data = state_sinusoids_withCIs_cont_sub_under19, linetype = 2) +
  scale_color_manual(values= subcolors_df$region_color, labels=gsub("_", " ",subcolors_df$Region , fixed=TRUE)) +
  scale_fill_manual(values = subcolors_df$region_color, labels=gsub("_", " ",subcolors_df$Region , fixed=TRUE)) +
  facet_wrap(~STATE) +
  # ggtitle("Streptococcal Pharyngitis Visits State Sinusoidal Fits") +
  labs(color = "Subregion", fill = "Subregion") + 
  xlab("Month") +
  ylab("Visits per 1,000 People") +
  scale_x_discrete(limits = c("JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEPT","OCT", "NOV", "DEC")) +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size = 20)) 
#only in the >19 population
state_sinusoids_subregions_over19 <- ggplot() + 
  geom_point(aes(x = MONTH, y = mean_weighted_cases_per_thousand, color = Region), data = state_sinusoids_withCIs_cont_sub_over19, size = 0.5) + 
  geom_ribbon(aes(x = MONTH, ymin = lower, ymax = upper, fill = Region), data = state_sinusoids_withCIs_cont_sub_over19, alpha = 0.2) +
  geom_line(aes(x = MONTH, y = prediction, color = Region), data = state_sinusoids_withCIs_cont_sub_over19, linetype = 2) +
  scale_color_manual(values= subcolors_df$region_color, labels=gsub("_", " ",subcolors_df$Region , fixed=TRUE)) +
  scale_fill_manual(values = subcolors_df$region_color, labels=gsub("_", " ",subcolors_df$Region , fixed=TRUE)) +
  facet_wrap(~STATE) +
  # ggtitle("Streptococcal Pharyngitis Visits State Sinusoidal Fits") +
  labs(color = "Subregion", fill = "Subregion") + 
  xlab("Month") +
  ylab("Visits per 1,000 People") +
  scale_x_discrete(limits = c("JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEPT","OCT", "NOV", "DEC")) +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size = 20)) 

#plot these together on the same plot but with diff
state_sinusoids_withCIs_cont_sub_over19_tojoin <- state_sinusoids_withCIs_cont_sub_over19 |> mutate(age = "over19")
state_sinusoids_withCIs_cont_sub_under19_tojoin <- state_sinusoids_withCIs_cont_sub_under19 |> mutate(age = "under19")

joint_agesep_sinusoids <- rbind(state_sinusoids_withCIs_cont_sub_over19_tojoin, state_sinusoids_withCIs_cont_sub_under19_tojoin)

joint_sinusoids <- joint_agesep_sinusoids |>
  ggplot() + 
  geom_point(aes(x = MONTH, y = mean_weighted_cases_per_thousand, color = Region, group = age, shape = age), size = 0.5) + 
   geom_ribbon(aes(x = MONTH, ymin = lower, ymax = upper, fill = Region, group = age), alpha = 0.2) +
   geom_line(aes(x = MONTH, y = prediction, color = Region, group = age), linetype = 2) +
   scale_color_manual(values= subcolors_df$region_color, labels=gsub("_", " ",subcolors_df$Region , fixed=TRUE)) +
   scale_fill_manual(values = subcolors_df$region_color, labels=gsub("_", " ",subcolors_df$Region , fixed=TRUE)) +
  facet_wrap(~STATE) + 
  labs(color = "Subregion", fill = "Subregion", shape = "Age") + 
  xlab("Month") +
  ylab("Visits per 1,000 People") +
  scale_x_discrete(limits = c("JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEPT","OCT", "NOV", "DEC")) +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size = 20)) 
```

Fit sinusoids to region trends and plot. Becomes Supplementary Figure 9a. 
```{r regional sinusoids plot, supplementary figure 8a}
#get_regions_sinusoids() from "region_subregion_sinusoid_functions.R"
region_sinusoids <- get_region_sinusoids(c("Hawaii", "Alaska"))[[1]] |>
   mutate(Region = factor(part, levels = c("South", "Midwest", "Northeast", "West")))

region_sinusoids_CIs_plot_points <- region_sinusoids |>
  ggplot(aes(x=MONTH)) + 
  geom_line(aes(x= MONTH, y = prediction, color = Region), linetype = 2) + 
  geom_point(aes(x= MONTH, y = yearly_average_sum_region_cases_per_thousand, color = Region), size = 1, data = region_sinusoids) +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill= Region), alpha = 0.2) +
  # ggtitle("Streptococcal Pharyngitis Visits Region Sinusoidal Fits") +
  xlab("Month") +
  labs(color = "Region", fill = "Region") + 
  ylab("Cases per 1,000 People") +
  scale_color_manual(values= colors_df$region_color, labels = colors_df$Region) +
  scale_fill_manual(values = colors_df$region_color, labels = colors_df$Region) +
  scale_x_discrete(limits = c("JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEPT","OCT", "NOV", "DEC")) +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size = 20)) 
```

Plot regional sinusoid phases. Becomes Supplementary Figure 9b.
```{r plot reginoal sinusoid phases, supplementary figure 8b}
region_sinusoids_parameters <- get_region_sinusoids(c("Hawaii", "Alaska"))[[2]]
order <- region_sinusoids_parameters |> arrange(-Phase) |> pull(Region)
order_df <- data.frame(Region = str_to_title(order), num = c(1:4))
regions_colors <- left_join(colors_df, order_df) |> arrange(num)
region_sinusoids_parameters <- region_sinusoids_parameters |> mutate(Region = factor(Region, order))
region_phase_plot <- region_sinusoids_parameters |> 
  mutate(lower = Phase - 1.96*Phase_SE, upper = Phase + 1.96*Phase_SE) |>
  ggplot(aes(x = Phase %% 12, y = Region, color = Region)) + geom_point() + geom_errorbar(aes(xmin = lower %%12, xmax = upper %%12), width = 0.2) + 
  theme_minimal() + 
  # ggtitle(paste("Phase Estimates for Region Sinusoids")) + 
  ylab("Region") + xlab("Month")+
  scale_x_discrete(limits = c("JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEPT","OCT", "NOV", "DEC")) +
  scale_color_manual(values= regions_colors$region_color, labels=regions_colors$Region) +
  scale_y_discrete(labels=levels(region_sinusoids_parameters$Region))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size = 20))
```


Fit sinusoids to subregional data and plot. Becomes Supplementary Figure 8a.
```{r supplementary figure 7a}
subregion_sinusoids <- get_subregion_sinusoids(c("Hawaii", "Alaska"))[[1]] |>
  mutate(Region = factor(part, c("East South Central", "West South Central",
                                      "West North Central", "South Atlantic", "Middle Atlantic",
                                      "Mountain West", "East North Central", "New England", "Pacific West")))
subregion_sinusoids_CIs_plot_points <- subregion_sinusoids |>
  ggplot(aes(x=MONTH)) + 
  geom_line(aes(x= MONTH, y = prediction, color = Region), linetype = 2) + 
  geom_point(aes(x= MONTH, y = yearly_average_sum_region_cases_per_thousand, color = Region), size = 1, data = subregion_sinusoids) +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill= Region), alpha = 0.2) +
  # ggtitle("Streptococcal Pharyngitis Visits Subregion Sinusoidal Fits") +
  labs(color = "Subregion", fill = "Subregion") + 
  ylab("Visits per 1,000 People") +
  scale_x_discrete(limits = c("JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEPT","OCT", "NOV", "DEC")) +
  scale_color_manual(values= subcolors_df$region_color, labels=subcolors_df$Region) +
  scale_fill_manual(values= subcolors_df$region_color, labels=subcolors_df$Region) +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size = 20))
```

Plot subregion phases. Becomes Supplementary Figure 8b.
```{r subregion phases, supplementary figure 7b}
subregion_sinusoids_parameters <- get_subregion_sinusoids(c("Hawaii", "Alaska"))[[2]]
order <- subregion_sinusoids_parameters |> arrange(-Phase) |> pull(Region)
order_df <- data.frame(Region = order, num = 1:9)
subregions_colors <- left_join(subcolors_df, order_df) |> arrange(num)
subregion_sinusoids_parameters <- subregion_sinusoids_parameters |> mutate(Region = factor(Region, order))
subregion_phase_plot <- subregion_sinusoids_parameters |> 
  mutate(lower = Phase - 1.96*Phase_SE, upper = Phase + 1.96*Phase_SE) |>
  ggplot(aes(x = Phase %% 12, y = Region, color = Region)) + geom_point() + geom_errorbar(aes(xmin = lower %%12, xmax = upper %%12), width = 0.2) + 
  theme_minimal() +
  # ggtitle(paste("Phase Estimates for Subregion Sinusoids")) +
  ylab("Subregion") + xlab("Month")+
  scale_x_discrete(limits = c("JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEPT","OCT", "NOV", "DEC")) +
  scale_color_manual(name = "Subregion", values= subregions_colors$region_color, labels=gsub("_", " ",subregions_colors$Region , fixed=TRUE)) +
  scale_y_discrete(labels=levels(subregion_sinusoids_parameters$Region)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size = 20)) 
```

Save region and subregion sinusoid phases into tables
```{r save parameters}
#Calculate subregion phases and 95% CIs
subregion_sinusoids_phase_table <- subregion_sinusoids_parameters |> 
  arrange(Phase) |>
  mutate(lower = Phase - 1.96*Phase_SE, upper = Phase + 1.96*Phase_SE) |>
  mutate(CI = paste0("(", round(lower,2),"-", round(upper,2), ")")) |>
  mutate(Phase_CI = paste(round(Phase, 2), CI)) |>
  mutate(Subregion = Region) |>
  select(Subregion, Phase_CI)

#Calculate region phases and 95% CIs
region_sinusoids_phase_table <- region_sinusoids_parameters |> 
  arrange(Phase) |>
  mutate(lower = Phase - 1.96*Phase_SE, upper = Phase + 1.96*Phase_SE) |>
  mutate(CI = paste0("(", round(lower,2),"-", round(upper,2), ")")) |>
  mutate(Phase_CI = paste(round(Phase, 2), CI)) |>
  mutate(Subregion = Region) |>
  select(Subregion, Phase_CI)

```



Calculate subregion centroids. Becomes Supplementary Figure 7a. 
```{r centroid analysis figure S7}
#load state centroid data from 2010 from USpopcenters package
state_centroid <- state2010 |>
  mutate(id = STNAME, lat = LATITUDE, long = LONGITUDE) |> 
  select(STATEFP, POPULATION, lat, long, id) |>
  filter(!id %in% c("Hawaii", "Alaska", "Puerto Rico"))


#change Washington DC to District of Columbia for mapping purposes
subregions_centroid <- subregions
subregions_centroid[which(subregions_centroid$STATE == "Washington DC"),1] = "District of Columbia"

#adjust state centroid format for joining
state_centroid_subregions <- state_centroid |> 
  mutate(STATE = id) |> 
  select(-id) |> 
  left_join(subregions_centroid)

#calculate the total populations in each subregion 
total_pops <- state_centroid_subregions |> 
  group_by(part) |>
  summarize(total_pop = sum(POPULATION))
sum(total_pops$total_pop) #sum is ~307,000,000 which makes sense for 2010 minus Hawaii/Alaska

#calculate population weighted average of state centroids
subregion_centroids <- state_centroid_subregions |> 
  left_join(total_pops) |> 
  mutate(state_weight = POPULATION/total_pop) |>
  mutate(weighted_lat = lat*state_weight,
         weighted_long = long*state_weight) |>
  group_by(part) |>
  summarize(subregion_lat = sum(weighted_lat), subregion_long = sum(weighted_long))
continental_fortified_tojoin_subregions <- continental_fortified_tojoin |> 
  mutate(STATE = id) |> left_join(subregions_centroid) |> 
  mutate(Region = factor(part, levels = c("East South Central", "West South Central",
                                          "West North Central", "South Atlantic", "Middle Atlantic",
                                          "Mountain West", "East North Central", "New England", "Pacific West")))

#calculate a distance reference point as the average between the two South regions with the earliest starts
ref_point <- subregion_centroids |> 
  filter(part %in% c("West South Central", "East South Central")) |> 
  left_join(total_pops) |>
  mutate(weight = total_pop / sum(total_pop)) |>
  mutate(weighted_lat = subregion_lat*weight,
         weighted_long = subregion_long*weight) |>
  summarize(ref_lat = sum(weighted_lat), ref_long = sum(weighted_long))

#plot subregions with their centroids and the reference point 
subregion_centroids_plot <- ggplot() + 
  geom_polygon(data = continental_fortified_tojoin_subregions, aes(x = long, y = lat, group = group, fill = Region), color="black", alpha = 0.5) +
  scale_fill_manual(name = "Subregion", values = subcolors_df$region_color, labels = subcolors_df$Region) +
  geom_point(data =subregion_centroids, aes(x = subregion_long, y = subregion_lat), color = "black", size = 3) +
  geom_point(data = ref_point, aes(x = ref_long, y = ref_lat), color = "red", size = 5) +
  theme_void() + ggtitle("") + 
  theme(plot.title = element_text(hjust = 0.5, size = 25),
        plot.subtitle = element_text(hjust = 0.5, size = 23),
        legend.position = 'bottom') 

#make a map of the state centroids; color by subregion and include reference point
state_centroid_map <- ggplot() + 
  geom_polygon(data = continental_fortified_tojoin_subregions, aes(x = long, y = lat, group = group, fill = Region), color="black", alpha = 0.5) +
  geom_point(data = state_centroid, aes(x = long, y = lat), color = "black") +
  geom_point(data = ref_point, aes(x = ref_long, y = ref_lat), color = "red", size = 5) +
  theme_void() + ggtitle("") +
  scale_fill_manual(name = "Subregion", values = subcolors_df$region_color, labels = subcolors_df$Region) +
  theme(plot.title = element_text(hjust = 0.5, size = 25),
        plot.subtitle = element_text(hjust = 0.5, size = 23),
        legend.position = 'bottom') 

subregions_colors_map <- ggplot() + 
  geom_polygon(data = continental_fortified_tojoin_subregions, aes(x = long, y = lat, group = group, fill = Region), color="black", alpha = 0.5) +
  theme_void() + ggtitle("") +
  scale_fill_manual(name = "Subregion", values = subcolors_df$region_color, labels = subcolors_df$Region) +
  theme(plot.title = element_text(hjust = 0.5, size = 25),
        plot.subtitle = element_text(hjust = 0.5, size = 23),
        legend.position = 'bottom') 

continental_fortified_tojoin_regions <- continental_fortified_tojoin_subregions |> select(-part) |> left_join(regions)
continental_fortified_tojoin_regions[which(continental_fortified_tojoin_regions$STATE == "District of Columbia"), 10] <- "South"
continental_fortified_tojoin_regions <- continental_fortified_tojoin_regions |> mutate(part = factor(part, levels = c("South", "Midwest", "Northeast", "West")))

region_map <- ggplot() +
  geom_polygon(data = continental_fortified_tojoin_regions, aes(x = long, y = lat, group = group, fill = part), color = "black", alpha = 0.5) +
  theme_void() + ggtitle("") +
  scale_fill_manual(name = "Region", values = colors_df$region_color, labels = c("South", "Midwest", "Northeast", "West")) +
  theme(plot.title = element_text(hjust = 0.5, size = 25),
        plot.subtitle = element_text(hjust = 0.5, size = 23),
        legend.position = 'bottom') 
```

Calculate distances from each subregion to the centroid and correlate with phases. Becomes Supplementary Figure 7b. 
```{r centroid analysis figure S7b}
#calculate euclidean distance and store in dataframe
dist_df <- data.frame(Subregion = subregion_centroids$part, 
                      dist = NA)
for(i in 1:length(dist_df$Subregion)){
  point <- subregion_centroids |> filter(part == dist_df$Subregion[i]) 
  dist_df$dist[i] = sqrt((point$subregion_lat - ref_point$ref_lat)^2 + (point$subregion_long - ref_point$ref_long)^2)
}

#find subregion phases
subregion_phase <- subregion_sinusoids_parameters |> 
  mutate(Subregion = factor(Region, levels = c("East South Central", "West South Central",
                                          "West North Central", "South Atlantic", "Middle Atlantic",
                                          "Mountain West", "East North Central", "New England", "Pacific West"))) |>
  select(Subregion, Phase) |> arrange(Subregion)
dist_df <- dist_df |> mutate(Subregion = factor(Subregion, levels = subregion_phase$Subregion)) |>
  arrange(Subregion)

cor(dist_df$dist, subregion_phase$Phase) #correlation is 0.7276

subregion_phase_dist_correlation <- left_join(subregion_phase, dist_df) |> 
  mutate(Region = Subregion) |> 
  left_join(subcolors_df) |> ggplot(aes(x = Phase, y = dist)) +
  geom_point(aes(color = Subregion)) + 
  theme_minimal() + geom_smooth(method = 'lm', color = 'black', linewidth = 0.3,linetype = 2, alpha = 0.2) +
  scale_color_manual(values = subcolors_df$region_color, labels = subcolors_df$Region) +
  ylab("Distance")

subregion_phase_dist_correlation_forfig <- subregion_phase_dist_correlation + theme(legend.position = "none")
```

Calculate distances from reference point to states and correlate. 
```{r}
#calculate euclidean distance and store in dataframe
dist_df_state <- data.frame(State = state_centroid$id, 
                      dist = NA)
for(i in 1:length(dist_df_state$State)){
  point <- state_centroid |> filter(id == dist_df_state$State[i]) 
  dist_df_state$dist[i] = sqrt((point$lat - ref_point$ref_lat)^2 + (point$long - ref_point$ref_long)^2)
}

#join state phases
#change DC so the two join ok
dist_df_state[8,1] <- "Washington DC"

#need to correct parameters to be in the proper range as above
state_sinusoids_parameters_tojoin <- state_sinusoids_parameters |> mutate(Phase_corrected = Phase %% 12)

state_phase_dist_df <- left_join(dist_df_state, state_sinusoids_parameters_tojoin)

cor(state_phase_dist_df$dist, state_phase_dist_df$Phase_corrected) #0.575

total_state_df <- state_phase_dist_df |> mutate(STATE = State) |> left_join(subregions) |> mutate(Region = part) |> left_join(subcolors_df) |> mutate(Subregion = factor(Region, levels = c("East South Central", "West South Central",
                                      "West North Central", "South Atlantic", "Middle Atlantic",
                                      "Mountain West", "East North Central", "New England", "Pacific West")))

state_distance_correlation_plot <- total_state_df |>
  ggplot(aes(x = Phase_corrected, y = dist)) + geom_point(aes(color = Subregion)) + 
  theme_minimal() + geom_smooth(method = 'lm', color = 'black', linewidth = 0.3,linetype = 2, alpha = 0.2) +
  scale_color_manual(values = subcolors_df$region_color, labels = subcolors_df$Region) +
  ylab("Distance") + xlab("Phase")
```


Load in trimmed school start data, calculate uptick points and plot. Becomes Supplementary Figure 11.
```{r school start date,figS11}
#summarize school start data
start_date_summary <- read_csv("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/output/school_starts_summary.csv")

subcolors_df_ordering <- data.frame(Subregion = c("East South Central", "West South Central",
                                      "West North Central", "South Atlantic", "Middle Atlantic",
                                      "Mountain West", "East North Central", "New England", "Pacific West"),
                           region_color = c(pal[6], pal[5], pal[4], pal[9], pal[2], pal[8], pal[3], pal[1], pal[7])) |> mutate(Subregion = factor(Subregion, levels = c("West South Central", "East South Central", "Mountain West",
                                                                                                               "West North Central", "South Atlantic", "East North Central", 
                                                                                                               "Pacific West", "Middle Atlantic", "New England"))) |> arrange(Subregion)


#calculate uptick points
region_totals <- pop_sizes |> 
  filter(!STATE %in% c("Hawaii", "Alaska")) |>
  left_join(subregions) |>
  group_by(part) |>
  summarize(region_total = sum(POPSIZE))


subregion_weightedvis_allyears <- left_join(dat, coh) |> left_join(subregions) |> left_join(pop_sizes) |>
  filter(!STATE %in% c("Hawaii", "Alaska")) |>
  left_join(region_totals) |>
  mutate(pop_frac = POPSIZE / region_total) |>
  mutate(group_weight = pop_frac/NMEMB) |>
  mutate(weighted_vis = NVISITS*group_weight) |>
  group_by(part, YEAR, MONTH) |>
  summarize(sum_region_vis_perthous = sum(weighted_vis)*1000)

#make a dataframe to fill that just has the regions and the years and a place to put the min month
month_mins <- expand_grid(YEAR = c(2010:2018), part = c("East South Central", "West South Central",
                                                        "West North Central", "South Atlantic", "Middle Atlantic",
                                                        "Mountain West", "East North Central", "New England", "Pacific West"), min = NA)

#fill dataframe
for(i in 1:nrow(month_mins)){
  df <- subregion_weightedvis_allyears |>
    filter(YEAR == month_mins[i,1], part == month_mins[i,2])
  month_mins[i,3] <- df[which(df$sum_region_vis_perthous == min(df$sum_region_vis_perthous)), 3]
}
#summarize month mins to have an average minimum month across all years for each region
avg_month_mins <- month_mins |> group_by(part) |> summarize(mean_min = mean(min), sd = sd(min)) |> mutate(lower = mean_min - 1.96*sd/3, upper = mean_min + 1.96*sd/3) |>
  mutate(Subregion = factor(part, levels = c("West South Central", "East South Central", "Mountain West",
                                                                                                               "West North Central", "South Atlantic", "East North Central", 
                                                                                                               "Pacific West", "Middle Atlantic", "New England"))) |>
  arrange(Subregion)

#arrange data for plotting
avg_subregionvis <- subregion_weightedvis_allyears |>
  group_by(part, MONTH) |> 
  summarize(avg_vis_perthous = mean(sum_region_vis_perthous), sd_vis = sd(sum_region_vis_perthous)) |>
  left_join(avg_month_mins) |> 
  mutate(lower = avg_vis_perthous - 1.96*sd_vis / 3, upper = avg_vis_perthous + 1.96*sd_vis / 3) |> 
  mutate(Region = Subregion) |>
  left_join(subcolors_df) |> arrange(Subregion)

subregion_uptick_plot <- avg_subregionvis |> 
  ggplot(aes(x = MONTH, y = avg_vis_perthous)) + geom_line(aes(color = Subregion)) +
  geom_ribbon(aes(x = MONTH, ymin = lower, ymax = upper, fill = Subregion), alpha = 0.2) + 
  theme_minimal() + scale_color_manual(values = subcolors_df_ordering$region_color) + geom_vline(aes(xintercept = mean_min), color = 'black', linetype = 2, alpha = 0.5) +
  scale_fill_manual(values = subcolors_df_ordering$region_color) + 
  facet_wrap(~Subregion) +
  ylab("Average Visits per 1000") +
  xlab("Month") +
  scale_x_discrete(limits = c("JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEPT","OCT", "NOV", "DEC")) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


avg_month_mins |> mutate(Date = date(duration(month = mean_min-1)), lower_date = date(duration(month = lower-1)),
                         upper_date =date(duration(month = upper-1)), cat = "Min Visit Date")
min_uptick_order <- avg_month_mins |> arrange(mean_min) |> pull(part)

month_mins_date <- avg_month_mins |> mutate(Date = date(duration(month = mean_min-1))-1, lower_date = date(duration(month = lower-1))-1,
                         upper_date =date(duration(month = upper-1))-1, cat = "Min Visit Date") |> 
  select(Subregion, Date, lower_date, upper_date, cat)

year(month_mins_date$Date) <- 2019
year(month_mins_date$lower_date) <- 2019
year(month_mins_date$upper_date) <- 2019

#combine school start and month min data into 1 dataframe for plotting
comb <- rbind(start_date_summary, month_mins_date) |> mutate(Subregion = factor(Subregion, levels = rev(min_uptick_order)))
uptickdates_plot <- comb |> ggplot(aes(x = Date, y = Subregion, color = cat)) + geom_point() + geom_errorbar(aes(xmin = lower_date, xmax = upper_date), width = 0.2, alpha = 0.5) +
  theme_minimal() + labs(color = "Date") + scale_color_manual(values = c("#FC8D62", "#66C2A5"),
                                     labels = c("Minimum Visit Date", "School Start Date" ))
```

Correlate start dates with uptick dates. Becomes Figure 3. 
```{r, correlation fig 3}
start_date <- start_date_summary |> mutate(reg = factor(Subregion, levels = rev(min_uptick_order))) |> arrange(reg) |> mutate(DateSS = Date) |> select(reg, DateSS)
min_date <- month_mins_date |> mutate(reg = factor(Subregion, levels = rev(min_uptick_order))) |> arrange(reg) |>
  mutate(DateMin = Date) |> select(reg, DateMin)
date_summaries <- left_join(start_date, min_date) |> mutate(dif = DateSS-DateMin)
range(date_summaries$dif) #28 to 47 days
min(date_summaries$dif) #28 days
max(date_summaries$dif) #47 days
mean(date_summaries$dif) #36.2 days

df_toplot <- left_join(comb, subcolors_df_ordering) |> pivot_wider(names_from = cat, values_from = c(Date, lower_date, upper_date)) |>
  mutate(Subregion = factor(Subregion, levels = min_uptick_order)) |> arrange(Subregion)

corrplot_schoolstart <- df_toplot |>
  ggplot(aes(x = Date_SchoolStart, y = `Date_Min Visit Date`)) + geom_point(aes(color = Subregion)) + scale_color_manual(values = df_toplot$region_color) +
  theme_minimal() + geom_smooth(method = 'lm', color = 'black', linewidth = 0.3,linetype = 2, alpha = 0.2) + 
  xlab("Average School Start Date") + ylab("Minimum Visit Date") 

corplot_labeled_points <- df_toplot |>
  ggplot(aes(x = Date_SchoolStart, y = `Date_Min Visit Date`)) + geom_point(aes(color = Subregion)) + scale_color_manual(values = df_toplot$region_color) + geom_text_repel(aes(label=Subregion)) +
  theme_minimal() + geom_smooth(method = 'lm', color = 'black', linewidth = 0.3,linetype = 2, alpha = 0.2) + 
  xlab("Average School Start Date") + ylab("Minimum Visit Date")  + theme(legend.position = "none")

cor(as.numeric(df_toplot$Date_SchoolStart), as.numeric(df_toplot$`Date_Min Visit Date`)) #raw correlation 0.88

```


Bootstrap correlation 
```{r school start correlation bootstrapping}
#bootstrap the uptick dates by sampling one of the 9 min dates from each subregion
subregions_vec <- c("West South Central", "East South Central", "Mountain West",
                "West North Central", "South Atlantic", "East North Central", 
                "Pacific West", "Middle Atlantic", "New England")


booted_mins <- data.frame(samp = 1:1000)
for(i in 1:length(unique(month_mins$part))){
  vec_to_add <- c()
  for(z in 1:1000){
    tmp <- month_mins |> filter(part == unique(month_mins$part)[i]) |> pull(min) |> sample(size = 9, replace = TRUE) |> mean()
    vec_to_add <- append(vec_to_add, tmp)
  }
  #filter to specific region
  booted_mins <- cbind(booted_mins, vec_to_add)
}

colnames(booted_mins)[2:10] <- unique(month_mins$part)

#do the same thing for school start data, make sure to keep in the same order as mins
counties_per_subregion <- ss_dat_trim |> group_by(`Census Division`) |> summarize(num_counties = n()) |> 
  mutate(part = factor(`Census Division`, levels = unique(month_mins$part))) |> arrange(part)
booted_schools <- data.frame(samp = 1:1000)
for(i in 1:length(unique(month_mins$part))){
  vec_to_add <- c()
  for(z in 1:1000){
    tmp <- ss_dat_trim |> filter(`Census Division` == unique(month_mins$part)[i]) |> pull(date) |> sample(size = as.numeric(counties_per_subregion[i,2]), replace = TRUE) |> mean()
    vec_to_add <- append(vec_to_add, tmp)
  }
  #filter to specific region
  booted_schools <- cbind(booted_schools, vec_to_add)
}

colnames(booted_schools)[2:10] <- unique(month_mins$part)

cor_vec <- c()
for(i in 1:1000){
  tmp <- cor(c(t(booted_mins[i,]))[2:10],c(t(as.numeric(booted_schools[i,])))[2:10])
  cor_vec <- append(cor_vec, tmp)
}

quantile(cor_vec, c(0.025, 0.5, 0.975))

```
```{r, subregion uptick correlations with school start by age group}
over19_comb <- start_date |> mutate(Subregion = reg) |> left_join(avg_month_mins_over19)
cor(as.numeric(over19_comb$DateSS), over19_comb$mean_min) #0.928
booted_mins_over19 <- data.frame(samp = 1:1000)
for(i in 1:length(unique(month_mins_over19$part))){
  vec_to_add <- c()
  for(z in 1:1000){
    tmp <- month_mins_over19 |> filter(part == unique(month_mins_over19$part)[i]) |> pull(min) |> sample(size = 9, replace = TRUE) |> mean()
    vec_to_add <- append(vec_to_add, tmp)
  }
  #filter to specific region
  booted_mins_over19 <- cbind(booted_mins_over19, vec_to_add)
}

colnames(booted_mins_over19)[2:10] <- unique(month_mins_over19$part)
colMeans(booted_mins_over19)
cor_vec_over19 <- c()
for(i in 1:1000){
  tmp <- cor(c(t(booted_mins_over19[i,]))[2:10],c(t(as.numeric(booted_schools[i,])))[2:10])
  cor_vec_over19 <- append(cor_vec_over19, tmp)
}
quantile(cor_vec_over19, c(0.025, 0.5, 0.975))
#      2.5%       50%     97.5% 
# 0.7618782 0.8929987 0.9700739 

under19_comb <- start_date |> mutate(Subregion = reg) |> left_join(avg_month_mins_under19)
cor(as.numeric(under19_comb$DateSS), under19_comb$mean_min) #0.826

booted_mins_under19 <- data.frame(samp = 1:1000)
for(i in 1:length(unique(month_mins_under19$part))){
  vec_to_add <- c()
  for(z in 1:1000){
    tmp <- month_mins_under19 |> filter(part == unique(month_mins_under19$part)[i]) |> pull(min) |> sample(size = 9, replace = TRUE) |> mean()
    vec_to_add <- append(vec_to_add, tmp)
  }
  #filter to specific region
  booted_mins_under19 <- cbind(booted_mins_under19, vec_to_add)
}

colnames(booted_mins_under19)[2:10] <- unique(month_mins_under19$part)
colMeans(booted_mins_under19)
cor_vec_under19 <- c()
for(i in 1:1000){
  tmp <- cor(c(t(booted_mins_under19[i,]))[2:10],c(t(as.numeric(booted_schools[i,])))[2:10])
  cor_vec_under19 <- append(cor_vec_under19, tmp)
}
quantile(cor_vec_under19, c(0.025, 0.5, 0.975))
#      2.5%       50%     97.5% 
# 0.7162034 0.8184663 0.8836837 
```

```{r, age}
#put this into age analyses
#want to look at the visits per person by age group, by region 
avg_yearly_regions_tojoin <- avg_yearly_regions |> mutate(part = Region) |> select(part, avg_vis_thous)
region_totals_cont <- pop_sizes |> 
  left_join(regions) |> 
  filter(!STATE %in% c("Hawaii", "Alaska")) |>
  group_by(part) |>
  summarize(region_total = sum(POPSIZE))

alldat_region <- left_join(vis_year, coh) |> left_join(regions) |> left_join(pop_sizes)

age_group_breakdown_table <- alldat_region |> 
  filter(!STATE %in% c("Hawaii", "Alaska")) |>
  left_join(region_totals_cont) |> 
  mutate(pop_frac = POPSIZE/region_total) |>
  mutate(group_weight = pop_frac/NMEMB) |>
  mutate(weighted_cases = yearly_visits*group_weight) |>
  group_by(part, AGEGRP, YEAR) |>
  summarize(sum_region_cases = sum(weighted_cases)) |>
  mutate(sum_region_cases_per_thousand = sum_region_cases*1000) |>
  group_by(AGEGRP, part) |>
  summarize(mean_vis_per_thousand = mean(sum_region_cases_per_thousand), sd = sd(sum_region_cases_per_thousand)) |>
  left_join(avg_yearly_regions_tojoin) |>
  mutate(age_freq = mean_vis_per_thousand / avg_vis_thous)

age_breakdown_plot <- age_group_breakdown_table |> ggplot(aes(part, age_freq, group = AGEGRP, fill = AGEGRP)) + geom_bar(stat = "identity") + theme_minimal() + scale_fill_manual(values = brewer.pal(n= 8, name= "Set2"), labels = c("0-4", "5-9", "10-19", "20-29", "30-39", "40-49", "50-59", "60-69")) + ylab("Visit Proportion") + xlab("Region") +
  labs(fill = "Age Group") + theme(legend.position = "none")

membership_byage <- left_join(total_memb_byregion_age, total_memb_byregion) |> mutate(age_freq = avg_memb_peryear / total_memb) |> 
  ggplot(aes(part, age_freq, fill = AGEGRP)) + geom_bar(stat = "identity") + scale_fill_manual(values = brewer.pal(n= 8, name= "Set2"), labels = c("0-4", "5-9", "10-19", "20-29", "30-39", "40-49", "50-59", "60-69")) + ylab("Membership Proportion") + xlab("Region") +
  labs(fill = "Age Group") + theme_minimal() + theme(legend.position = "none")

  
age_month_plot <- ggplot() +
  geom_point(aes(MONTH, sum_weighted_vis_per_thous, group = AGEGRP, color = AGEGRP), data = weighted_age_groups_yearly, size = 0.3) + 
  geom_line(aes(MONTH, avg_vis_per_thous, group = AGEGRP, color = AGEGRP), data = weighted_age_groups_permonth) +
  geom_ribbon(aes(MONTH, ymin = avg_vis_per_thous - 1.96*sd/3, ymax = avg_vis_per_thous + 1.96*sd/3, fill = AGEGRP), alpha = 0.3, data = weighted_age_groups_permonth) + scale_fill_manual(name = "Age Group", values = brewer.pal(n= 8, name= "Set2"), labels = c("0-4", "5-9", "10-19", "20-29", "30-39", "40-49", "50-59", "60-69")) + scale_color_manual(name = "Age Group", values = brewer.pal(n= 8, name= "Set2"), labels = c("0-4", "5-9", "10-19", "20-29", "30-39", "40-49", "50-59", "60-69")) + scale_x_discrete(limits = c("JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEPT","OCT", "NOV", "DEC")) + xlab("Month") + ylab("Visits per 1000 People") +
  theme_minimal()  + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
 


```


```{r}
#school start correlation at the state label
#can see if I really need to pull this in or can summarize from ss_dat_trim
start_date_summary_state <- read_csv("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/output/school_starts_summary_state.csv")

state_weighted_vis_allyears_cont <- state_weighted_vis_allyears |> filter(!STATE %in% c('Hawaii', 'Alaska')) |> group_by(STATE, MONTH, YEAR) |> select(-part) |> left_join(subregions)

#now do uptick points for each state
state_month_mins <- expand_grid(YEAR = c(2010:2018), STATE = unique(state_weighted_vis_allyears_cont$STATE), min = NA)

#this takes a long time, save the output and reload it in
# for(i in 1:nrow(state_month_mins)){
#   df <- state_weighted_vis_allyears_cont |>
#     filter(YEAR == state_month_mins[i,1], STATE == state_month_mins[i,2])
#   state_month_mins[i,3] <- df[which(df$weighted_cases_per_thousand == min(df$weighted_cases_per_thousand)), 2]
# }

#saveRDS(state_month_mins, "/Users/madeleinekline/Dropbox (Harvard University)/GradLab/Strep_project/8_25_analysis/state_month_mins.RDS")

state_month_mins <- readRDS("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/Strep_project/8_25_analysis/state_month_mins.RDS")


range(state_month_mins$min) #this has a wider range, from 5-11
avg_state_mins <- state_month_mins |> 
  group_by(STATE) |>
  summarize(avg_min_month = mean(min), sd_min = sd(min)) |>
  arrange(avg_min_month) |>
  mutate(lower_min = avg_min_month - 1.96*sd_min/3, upper_min =  avg_min_month + 1.96*sd_min/3)

#Plot these now on a plot of the averages per state
state_weighted_vis_avg <- state_weighted_vis_allyears_cont |> 
  group_by(STATE, MONTH, part) |>
  summarize(avg_vis_per_thousand = mean(weighted_cases_per_thousand), sd = sd(weighted_cases_per_thousand)) |>
   mutate(lower = avg_vis_per_thousand - 1.96*sd/3, upper = avg_vis_per_thousand + 1.96*sd/3) |>
  left_join(avg_state_mins)

state_uptick_plot <- state_weighted_vis_avg |> 
  mutate(Region = factor(part, subcolors_df$Region)) |>
  ggplot(aes(x = MONTH, y = avg_vis_per_thousand)) + geom_line(aes(color = Region)) +
  geom_ribbon(aes(x = MONTH, ymin =lower, ymax = upper, fill = Region), alpha = 0.2) + 
  theme_minimal() + scale_color_manual(values = subcolors_df$region_color) + geom_vline(aes(xintercept = avg_min_month), color = 'black', linetype = 2, alpha = 0.5) +
  scale_fill_manual(values = subcolors_df$region_color) + 
  facet_wrap(~STATE) +
  ylab("Average Visits per 1000") +
  xlab("Month") +
  scale_x_discrete(limits = c("JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEPT","OCT", "NOV", "DEC")) +
  theme(axis.text.x = element_blank())


#now get state-level school start data
state_month_mins_date <- avg_state_mins |> mutate(Uptick_Date = date(duration(month = avg_min_month-1))-1, uptick_lower_date = date(duration(month = lower_min-1))-1,
                                                  uptick_upper_date =date(duration(month = upper_min-1))-1) |>
  select(STATE, Uptick_Date, uptick_lower_date, uptick_upper_date)

year(state_month_mins_date$Uptick_Date) <- 2019
year(state_month_mins_date$uptick_lower_date) <- 2019
year(state_month_mins_date$uptick_upper_date) <- 2019


state_name_to_abb <- data.frame(STATE = state.name, State = state.abb)
state_month_mins_date <- left_join(state_month_mins_date, state_name_to_abb)
state_month_mins_date$State[44] <- "DC"

combined_dates <- left_join(state_month_mins_date, start_date_summary_state) |> select(STATE, State, Uptick_Date, uptick_lower_date, 
                                                                     uptick_upper_date, Date, lower_date, upper_date) |> left_join(subregions)

#correlation:
cor(as.numeric(combined_dates$Uptick_Date), as.numeric(combined_dates$Date)) #correlation raw is ~0.84

total_comb <- combined_dates |> mutate(Region = part) |> left_join(subcolors_df) |>
  mutate(part = factor(part, levels =  c("East South Central", "West South Central",
                                         "West North Central", "South Atlantic", "Middle Atlantic",
                                         "Mountain West", "East North Central", "New England", "Pacific West")))

#plot the correlation
state_correlation_plot <- total_comb |> ggplot(aes(x = Date, y = Uptick_Date, color = part)) + geom_point() +
  theme_minimal() + geom_smooth(method = 'lm', color = 'black', linewidth = 0.3,linetype = 2, alpha = 0.2) + 
  xlab("School Start Date") + ylab("Minimum Visit Date") + labs(color = "Subregion") +
  scale_color_manual(values = subcolors_df$region_color)

#Now bootstrap the uptick dates
booted_uptick_state <- data.frame(samp = 1:1000)
for(i in 1:length(unique(state_month_mins_date$STATE))){
  vec_to_add <- c()
  for(z in 1:1000){
    tmp <- state_month_mins_date |> filter(STATE == unique(state_month_mins_date$STATE)[i]) |> pull(Uptick_Date) |>
    sample(size = 9, replace = TRUE) |> mean()
    vec_to_add <- append(vec_to_add, tmp)
  }
  booted_uptick_state <- cbind(booted_uptick_state, vec_to_add)
}
colnames(booted_uptick_state) <- unique(state_month_mins_date$STATE)


#do the same thing with schools
#calculate counties per state
counties_per_state <- ss_dat_trim |> group_by(State) |> summarize(num_counties = n()) |>
  mutate(State = factor(State, state_month_mins_date$State)) |> arrange(State)
booted_schools_state <- data.frame(samp = 1:1000)
for(i in 1:length(unique(state_month_mins_date$State))){
  vec_to_add <- c()
  for(z in 1:1000){
    tmp <- ss_dat_trim |> filter(State == unique(state_month_mins_date$State)[i]) |> pull(date) |>
      sample(size = as.numeric(counties_per_state[i,2]), replace = TRUE) |> mean()
    vec_to_add <- append(vec_to_add, tmp)
  }
  booted_schools_state <- cbind(booted_schools_state, vec_to_add)
}

colnames(booted_schools_state) <- unique(state_month_mins_date$State)

corvec <- c()
for(i in 1:1000){
  tmp <- cor(c(t(as.numeric(booted_schools_state[i,])))[2:50],c(t(as.numeric(booted_uptick_state[i,])))[2:50])
  corvec <- append(corvec, tmp)
}

mean(corvec) #0.837, very similar

quantile(corvec, probs = c(0.025, 0.5, 0.975))
#      2.5%       50%     97.5% 
# 0.8169280 0.8381871 0.8563717 


#make plots of the states with error bars 
uptickdate_state <- total_comb |> select(STATE, State, Uptick_Date, uptick_lower_date, uptick_upper_date, Region) |>
  mutate(Date = Uptick_Date, lower_date=uptick_lower_date, upper_date= uptick_upper_date, cat = "Uptick") |>
  select(STATE, State, Date, lower_date, upper_date, cat, Region)

#order them by uptick date
state_order_uptick <- uptickdate_state |> arrange(desc(Date)) |> pull(STATE)

school_state <- total_comb |> select(STATE, State, Date, lower_date, upper_date, Region) |>
  mutate(cat = "School_Start") |>
  select(STATE, State, Date, lower_date, upper_date, cat, Region)

comb_long <- rbind(uptickdate_state, school_state) |> 
  mutate(STATE = factor(STATE, levels = state_order_uptick)) |>
  arrange(desc(STATE))
state_errorbars <- comb_long |> ggplot(aes(x= Date,y = STATE, group = cat, color = cat)) + geom_point() +
  geom_errorbar(aes(xmin = lower_date, xmax = upper_date)) + theme_minimal() + 
  ylab("State") + scale_color_manual(values = c("#66C2A5","#FC8D62"),
                                     labels = c("School Start Date", "Minimum Visit Date")) +
  labs(color = "Date")
 
#find mean and range of the difference
total_comb$Date - total_comb$Uptick_Date
mean(total_comb$Date - total_comb$Uptick_Date)
range(total_comb$Date - total_comb$Uptick_Date
)

```
```{r}
#repeat correlation analysis at a subregional level but with just the under 19 and over 19 populations
comb_under19 <- rbind(start_date_summary, month_mins_date_under19) |> mutate(Subregion = factor(Subregion, levels = rev(min_uptick_order_under19)))
uptickdates_plot_under19 <- comb_under19 |> ggplot(aes(x = Date, y = Subregion, color = cat)) + geom_point() + geom_errorbar(aes(xmin = lower_date, xmax = upper_date), width = 0.2, alpha = 0.5) +
   theme_minimal() + labs(color = "Date") + scale_color_manual(values = c("#FC8D62", "#66C2A5"),
                                                               labels = c("Minimum Visit Date", "School Start Date" ))
month_mins_date_over19_noagecol <- month_mins_date_over19 |> select(-age)
comb_over19 <- rbind(start_date_summary, month_mins_date_over19_noagecol) |> mutate(Subregion = factor(Subregion, levels = rev(min_uptick_order_over19)))

uptickdates_plot_over19 <- comb_over19 |> ggplot(aes(x = Date, y = Subregion, color = cat)) + geom_point() + geom_errorbar(aes(xmin = lower_date, xmax = upper_date), width = 0.2, alpha = 0.5) +
   theme_minimal() + labs(color = "Date") + scale_color_manual(values = c("#FC8D62", "#66C2A5"),
                                                               labels = c("Minimum Visit Date", "School Start Date" ))

#plot the two uptick dates from under and over 19 next to one another with school start dates
month_mins_date_under19_tojoin <- month_mins_date_under19 |> mutate(group = "under19")
month_mins_date_over19_tojoin <- month_mins_date_over19_noagecol |> mutate(group = "over19")
start_date_summary_tojoin <- start_date_summary |> mutate(group = "schoolstart")

comb_ages <- rbind(month_mins_date_under19_tojoin, month_mins_date_over19_tojoin, start_date_summary_tojoin) |> mutate(Subregion = factor(Subregion , levels = rev(min_uptick_order_under19))) |> arrange(Subregion)
bothages_uptick_plot <- comb_ages |> ggplot(aes(x = Date, y = Subregion, color = group)) + geom_point() + geom_errorbar(aes(xmin = lower_date, xmax = upper_date), width = 0.2, alpha = 0.5) +
   theme_minimal() + labs(color = "Date") + scale_color_manual(values = c( "#E69F00", "#009E73",  "#D55E00"),
                                                               labels = c("Over 19 Minimum Visit Date", "School Start Date", "Under 19 Minimum Visit Date"))

#calculate the differences between school start date and minimum visit date in each region
under19_dates <- comb_ages |> filter(group == "under19") |> pull(Date)
over19_dates <- comb_ages |> filter(group == "over19") |> pull(Date)
school_dates <- comb_ages |> filter(group == "schoolstart") |> pull(Date)

#under 19
range(under19_dates - school_dates) #51 and 29 days apart
mean(under19_dates - school_dates) #mean 39 days apart

#over19
range(over19_dates - school_dates) #38 and 4 days apart
mean(over19_dates - school_dates) #mean 16.44 days apart


threeages <- rbind(month_mins_date_under4, month_mins_date_fivetonineteen, month_mins_date_over19) |>
  mutate(Subregion = factor(Subregion, levels = rev(min_uptick_order_fivetonineteen))) |> 
  arrange(Subregion)

threeagegroup_plot <- threeages |> ggplot(aes(x = Date, y = Subregion, color = age)) + geom_point() + geom_errorbar(aes(xmin = lower_date, xmax = upper_date), width = 0.2, alpha = 0.5) +
   theme_minimal() + labs(color = "Date") + scale_color_manual(name = "Age Group",
     values = c("#D95F02","#E6AB02","#A6761D"),
                                                               labels = c("5-19", "Over 19", "Under 4")) 

```

```{r eval= FALSE}
#write all tables
write_csv(table1, "/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/output/study_population_table_table1.csv")
write_csv(region_table, "/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/output/Average_region_year.csv")
write_csv(subregion_table, "/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/output/Average_subregion_year.csv")
write_csv(region_table_month, "/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/output/Average_region_month.csv")
write_csv(subregion_table_month, "/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/output/Average_subregion_month.csv")
write_csv(region_quarters_table, "/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/output/region_quarters_table.csv")
write_csv(subregion_quarters_table, "/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/output/subregion_quarters_table.csv")
write_csv(quarter_diffs_table, "/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/output/quarter_diffs_region_table_S4.csv")
write_csv(wide_table_regions, "/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/output/continental_US_regions_table_wide.csv")
write_csv(wide_table_subregions, "/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/output/continental_US_subregions_table_wide.csv")
write_csv(phase_table, "/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/output/State_phase_table_S5.csv")
write_csv(subregion_sinusoids_parameters, "/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/output/subregion_sinusoids_parameters.csv")
write_csv(region_sinusoids_parameters, "/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/output/region_sinusoids_parameters.csv")
write_csv(subregion_sinusoids_phase_table, "/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/output/subregion_phase_table.csv")
write_csv(region_sinusoids_phase_table, "/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/output/region_phase_table.csv")
write_csv(ttest_table_sub, "/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/output/subregion_comparisons_yearly_pvals.csv")
write_csv(state_month_mins_date, '/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/output/state_month_mins_table.csv')

#save all figures as pngs and pdfs
##main figures
#fig 1
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/fig1.png", points_region_plot, width = 7, height =5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/fig1.pdf", points_region_plot, width = 7, height =5)

#fig 2
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/fig2.png", state_phases_map_noSC, width = 7, height = 5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/fig2.pdf", state_phases_map_noSC, width = 7, height = 5)

#fig 3
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/fig3.png", uptickdates_plot, width =7, height =5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/fig3.pdf", uptickdates_plot, width =7, height =5)

##supplemental figures
#fig S1
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS1.png", continental_state_membership_noSC, width = 6, height = 3)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS1.pdf", continental_state_membership_noSC, width = 6, height = 3)

#fig S2
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS2a.pdf", membership_byage, width = 5, height = 3.5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS2a.png", membership_byage, width = 5, height = 3.5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS2b.pdf", age_breakdown_plot, width = 5, height = 3.5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS2b.png", age_breakdown_plot, width = 5, height = 3.5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS2c.pdf", age_month_plot, width = 5, height = 3.5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS2c.png", age_month_plot, width = 5, height = 3.5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS2.pdf", grid.arrange(membership_byage, age_breakdown_plot, age_month_plot, layout_matrix = rbind(c(1,1,1,2,2,2),c(1,1,1,2,2,2), c(4,3,3,3,3,4),c(4,3,3,3,3,4))), width = 7, height = 6)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS2.png", grid.arrange(membership_byage, age_breakdown_plot, age_month_plot, layout_matrix = rbind(c(1,1,1,2,2,2),c(1,1,1,2,2,2), c(4,3,3,3,3,4),c(4,3,3,3,3,4))), width = 7, height = 6)

#fig S3
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS3a.png", region_differences_byyear, width = 5, height = 3.5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS3a.pdf", region_differences_byyear, width = 5, height = 3.5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS3b.png", year_averages_plot, width = 5, height = 3.5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS3b.pdf", year_averages_plot, width = 5, height = 3.5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS3c.png", region_comparisons, width = 5, height = 3.5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS3c.pdf", region_comparisons, width = 5, height = 3.5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS3.pdf", grid.arrange(region_differences_byyear_forfig, year_averages_plot, region_comparisons, layout_matrix = rbind(c(1,1,1,2,2,2),c(1,1,1,2,2,2), c(4,3,3,3,3,4),c(4,3,3,3,3,4))), width = 7, height = 6)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS3.png", grid.arrange(region_differences_byyear_forfig, year_averages_plot, region_comparisons, layout_matrix = rbind(c(1,1,1,2,2,2),c(1,1,1,2,2,2), c(4,3,3,3,3,4),c(4,3,3,3,3,4))), width = 7, height = 6)

#fig S4
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS4a.png", subregion_differences_byyear, width = 5, height = 3.5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS4a.pdf", subregion_differences_byyear, width = 5, height = 3.5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS4b.png", year_averages_plot_subregions, width =5, height = 3.5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS4b.pdf", year_averages_plot_subregions, width =5, height = 3.5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS4.pdf", grid.arrange(subregion_differences_byyear_forfig, year_averages_plot_subregions, ncol = 2, layout_matrix = rbind(c(1,1,1,2,2,2,2))),  width = 8, height = 4)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS4.png", grid.arrange(subregion_differences_byyear_forfig, year_averages_plot_subregions, ncol = 2, layout_matrix = rbind(c(1,1,1,2,2,2,2))),  width = 8, height = 4)

#fig S5
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS5a.png", region_quarters_plot, width = 5, height = 4)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS5a.pdf", region_quarters_plot, width = 5, height = 4)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS5b.png", subregion_quarters_plot, width = 5, height = 4)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS5b.pdf", subregion_quarters_plot, width = 5, height = 4)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS5.pdf", grid.arrange(region_quarters_plot, subregion_quarters_plot), width = 7, height = 10)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS5.png", grid.arrange(region_quarters_plot, subregion_quarters_plot), width = 7, height = 10)

#fig S6
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS6.png", points_subregion_plot, width = 7, height = 5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS6.pdf", points_subregion_plot, width = 7, height = 5)


#fig S7
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS7a.png", region_heatmap_significance_noredund, width = 5, height = 3.5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS7a.pdf", region_heatmap_significance_noredund, width = 5, height = 3.5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS7b.png", subregion_heatmap_significance_noredund, width = 6.5, height = 6.5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS7b.pdf", subregion_heatmap_significance_noredund, width = 6.5, height = 6.5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS7.pdf", grid.arrange(region_heatmap_significance_noredund, subregion_heatmap_significance_noredund), width = 7, height = 11)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS7.png", grid.arrange(region_heatmap_significance_noredund, subregion_heatmap_significance_noredund), width = 7, height = 11)

#fig s8
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS8a.pdf", under_19_monthly_vis_plot, width = 7, height = 5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS8a.png", under_19_monthly_vis_plot, width = 7, height = 5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS8b.pdf", over_19_monthly_vis_plot, width = 7, height = 5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS8b.png", over_19_monthly_vis_plot, width = 7, height = 5)
under_19_monthly_vis_plot_nolegend <- under_19_monthly_vis_plot + theme(legend.position = "none")
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS8.pdf",
       grid.arrange(under_19_monthly_vis_plot_nolegend, over_19_monthly_vis_plot, ncol =2, layout_matrix =rbind(c(1,1,1,1,2,2,2,2,2,2))), width =8, height = 4)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS8.png",
       grid.arrange(under_19_monthly_vis_plot_nolegend, over_19_monthly_vis_plot, ncol =2, layout_matrix =rbind(c(1,1,1,1,2,2,2,2,2,2))), width =8, height = 4)

#fig S9
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS9.pdf", state_sinusoids_subregions +theme(axis.text.x = element_blank()), width =8.5, height =6)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS9.png", state_sinusoids_subregions  + theme(axis.text.x = element_blank()), width =8.5, height =6)

#fig S10
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS10a.png", subregion_sinusoids_CIs_plot_points, width = 7, height = 5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS10a.pdf", subregion_sinusoids_CIs_plot_points, width = 7, height = 5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS10b.png",subregion_phase_plot, width = 7, height = 5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS10b.pdf",subregion_phase_plot, width = 7, height = 5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS10.pdf", grid.arrange(subregion_sinusoids_CIs_plot_points, subregion_phase_plot), width = 7, height = 9)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS10.png", grid.arrange(subregion_sinusoids_CIs_plot_points, subregion_phase_plot), width = 7, height = 9)

#fig S11
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS11a.png", region_sinusoids_CIs_plot_points, width = 7, height = 5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS11a.pdf", region_sinusoids_CIs_plot_points, width = 7, height = 5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS11b.png", region_phase_plot, width = 7, height = 5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS11b.pdf", region_phase_plot, width = 7, height = 5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS11.pdf", grid.arrange(region_sinusoids_CIs_plot_points, region_phase_plot), width = 7, height = 9)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS11.png", grid.arrange(region_sinusoids_CIs_plot_points, region_phase_plot), width = 7, height = 9)

#fig S12
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS12a.png", subregion_centroids_plot, width = 9, height = 6.5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS12a.pdf", subregion_centroids_plot, width = 9, height = 6.5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS12b.png", subregion_phase_dist_correlation, width = 9, height = 6.5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS12b.pdf", subregion_phase_dist_correlation, width = 9, height = 6.5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS12.png", grid.arrange(subregion_centroids_plot, subregion_phase_dist_correlation_forfig, ncol = 1), width = 7, height = 9)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS12.pdf", grid.arrange(subregion_centroids_plot, subregion_phase_dist_correlation_forfig, ncol = 1), width = 7, height = 9)

#fig S13
#state level distance plots
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS13a.pdf", state_centroid_map, width =9, height = 6.5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS13a.png", state_centroid_map, width =9, height = 6.5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS13b.pdf", state_distance_correlation_plot, width = 9, height = 6.5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS13b.png", state_distance_correlation_plot, width = 9, height = 6.5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS13.pdf", grid.arrange(state_centroid_map, state_distance_correlation_plot), width = 7, height = 9)

#fig S14
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS14a.png", subregion_uptick_plot, width =7, height =5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS14a.pdf", subregion_uptick_plot, width =7, height =5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS14b.png", corrplot_schoolstart, width =7, height =5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS14b.pdf", corrplot_schoolstart, width =7, height =5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS14_unedited.pdf", grid.arrange(subregion_uptick_plot, corrplot_schoolstart, ncol = 1), width = 7, height = 9)

#fig S15
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS15.png", state_uptick_plot, width = 8.5, height = 6)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS15.pdf", state_uptick_plot, width = 8.5, height = 6)

#fig S16
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS16a.pdf", state_correlation_plot, width = 7, height = 5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS16a.png", state_correlation_plot, width = 7, height = 5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS16b.pdf", state_errorbars, width = 7, height = 5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS16b.png", state_errorbars, width = 7, height = 5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS16.pdf", grid.arrange(state_correlation_plot, state_errorbars, ncol = 1), width = 7, height = 10)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS16.png", grid.arrange(state_correlation_plot, state_errorbars, ncol = 1), width = 7, height = 10)

#fig S17
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS17.pdf",threeagegroup_plot, width = 7, height = 5)
ggsave("/Users/madeleinekline/Dropbox (Harvard University)/GradLab/StrepPharyngitis/figures/figS17.png",threeagegroup_plot, width = 7, height = 5)

```

make gif, this step takes a while
```{r}
source('make_gif.R')
```

